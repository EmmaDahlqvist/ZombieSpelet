<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <title>Zombiespelet</title>
</head>
<body class="game">

<script src="simple.js">


// SPEED på space
// med t.ex 10 uses

//ljudeffekter
//labyrint - hitta målet, zombies spawnar bakom väggen
//healthbar zombie & spelare
//ändra zombie till en gubbe med pistol
//level 2 i slutet på labyrinten??

//börja med väggar

//skapa objekt
var zombies = [];
var color = "green";

var score = 0;
var level = 0;
var playerSpeed = 5;


for (let i = 0; i < 0; i++) {
    zombies.push({
        x: random(totalWidth),
        y: random(totalHeight),
        speed: random(1, 3),
        health: 5
    });
}

var players = [];

for (let i = 0; i < 2; i++) {
    players.push({
        x: totalWidth / 2,
        y: totalHeight / 2,
        health: 20
    });
}

const alive = [players[0], players[1]];
const projectile = [];
const coins = [];
for(let i = 0; i < 5; i++){
        coins.push({
        x: random(50, totalWidth-120),
        y: random(50, totalHeight-150),
        color: "yellow" 
    });
}

var healthBar = []; //healthbar för två spelare

healthBar.push({
    x: 0,
    y: 0
});
healthBar.push({
    x: 250,
    y: 0
});


//spara highscore i local storage
function addHighscore() {
    for (let i = 0; i < 5; i++) {
        let scores = localStorage.getItem("highscore" + i);
        if (score > scores || scores === null) { //kolla om score är högre än nuvarande plats 1-5 score
            localStorage.setItem("highscore" + i, score);
            console.log("works");
            break;
        }
    }

}

/*Huvudloopen*/
function update() {
    clearScreen();
    //level display
    text(500, 70, 20, "SCORE: " + score, "red");

    //splare och spelar movement
    CreateMap();
    CreatePlayer(0);
    CreatePlayer(1);


    //loop för zombies
    for (let i = 0; i < zombies.length; i++) {
        var zombie = zombies[i];

        picture(zombie.x, zombie.y, "img/police.png");

        var nearestPlayer = [];
        //hitta närmaste spelare
        if (alive.length == 2) { //båda spelare lever fortfarande
            if (distance(players[0], zombie) < distance(players[1], zombie)) { //spelare index 0 är närmast
                nearestPlayer = players[0];

            } else if (distance(players[0], zombie) > distance(players[1], zombie)) { //spelare index 1 är närmast
                nearestPlayer = players[1];

            } else if (distance(players[0], zombie) == distance(players[1], zombie)) { //de är lika nära, attackera någon levande
                nearestPlayer = alive[0]; //default target
            }
        } else if (alive.length == 1) { // bara en spelare är levande, attackera den
            nearestPlayer = alive[0];
        } else {
            alert("Both players are dead");
        }

        if (mouse.left) {
            AttackZombie(zombie);
        }


        //attackera närmsta spelare
        AttackPlayer(nearestPlayer, zombie);

        //skada
        if (distance(nearestPlayer.x, nearestPlayer.y, zombie.x, zombie.y) < 5) {
            nearestPlayer.health -= 0.5;
        }

        //spelare dör
        if (nearestPlayer.health == 0) {
            //om spelaren är levande, ta bort från levande listan
            playSound("sounds\mixkit-arcade-retro-game-over-213.wav", 1);
            if (alive.length > 0) {
                let index = alive.indexOf(nearestPlayer);
                console.log(index);
                alive.splice(index, 1);
            }

            //om båda spelare har dött (levande listans längd är noll)
            else if (alive.length == 0) {
                addHighscore();
                alert("YOU LOST!");
                stopUpdate();
            }
        }

    } //slut på zombie loop
}

//spara alla koordinater
const map = [
    [200, 0, 50, 300],
    [500, totalHeight-300, 50, 300],
    [500, totalHeight-300, 300, 50],
    [750, 0, 50, 100]
];

function CreateMap(){
    let topBorder = rectangle(0, 0, totalWidth, 50, "black");
    let leftBorder = rectangle(0, 0, 50, totalHeight, "black");
    let bottomBorder = rectangle(0, totalHeight-50, totalWidth, 50, "black");
    let rightBorder = rectangle(totalWidth-50, 0, 50, totalHeight, "black");

    //visualisera map
    for(let i = 0; i < map.length; i++){
        rectangle(map[i][0], map[i][1], map[i][2], map[i][3], "red");
    }

    //placera ut coins
    for(let i = 0; i < coins.length; i++){
        circle(coins[i].x, coins[i].y, 20, color);
    }
}

//skapa spelare (grafiskt), index 0 eller 1
function CreatePlayer(playerIndex) {
    Movement(playerIndex);
    Health(playerIndex);

    if (playerIndex == 0) { // spelare 1
        if (players[playerIndex].health > 0) {
            var player = picture(players[playerIndex].x, players[playerIndex].y, "img/playeroneLevel2.png");
        }

    } else { //spelare 2
        if (players[playerIndex].health > 0) {
            var player = picture(players[playerIndex].x, players[playerIndex].y, "img/playeroneLevel1.png");
        }
    }

        for(let t = 0; t < coins.length; t++){
            if(distance(players[0].x, players[0].y, coins[t].x, coins[t].y) < 10 || distance(players[1].x, players[1].y, coins[t].x, coins[t].y) < 10){
                coins.splice(t, 1);
                score++;
            }
        }
}

//zombie attack (ska senare spawna t.ex mellan 1- 3 zombies när man är på visst x / y)
function AttackPlayer(player, zombie) {

    if (zombie.health > 0) { // om zombien inte är död

        if (zombie.x < player.x) {
            zombie.x += zombie.speed;
        } else {
            zombie.x -= zombie.speed;
        }
        if (zombie.y < player.y) {
            zombie.y += zombie.speed;
        } else {
            zombie.y -= zombie.speed;
        }
    }
}

function AttackZombie(zombie) {
    projectile.push({
        x: players[0].x,
        y: players[0].y,
        time: 100
    });

    //du kan bara skjuta en åt gången
    if (projectile.length <= 1) {

        //variabler för att inte projektilen ska byta håll
        var X;
        var Y;

        //sida sida
        if(projectile[0].x < mouse.x){
        X = 1;
    } else if (projectile[0].x > mouse.x){
        X = -1;
    }

    //upp och ner
    if(projectile[0].y > mouse.y){
        Y = -1;
    } else if(projectile[0].y < mouse.y){
        Y = 1;
    }

    //om man siktar upp/ner eller åt sidan
    if(Math.abs((projectile[0].y - mouse.y)) < 15){
        Y = 0;
    }
    if(Math.abs((projectile[0].x - mouse.x)) < 15){
        X = 0;
    }

        var shooter = setInterval(function() {
            Projectile(X, Y);
        }, 1);
        setTimeout(function() {
            clearTimeout(shooter);
            projectile.splice(0);
        }, 1000); //ta bort projektilen om 1sekund
    }
}

//bestämmer åt vilket håll projektilen ska skjuta
function Projectile(X, Y) {

    projectile[0].x += X;
    projectile[0].y += Y;

    var shot = rectangle(projectile[0].x, projectile[0].y, 10, 10, "black");

    //om projektilen är tillräckligt nära zombien -> ta skada
    for (let i = 0; i < zombies.length; i++) {

        if (distance(projectile[0].x, projectile[0].y, zombies[i].x, zombies[i].y) < 15 && zombies[i].health > 0) {
            zombies[i].health--;
            console.log(zombies[i].health + " health");
            if(zombies[i].health == 0){
                score++;
                zombies.splice(i, 1);
            }
        }
    }
}

//kollar om spelare har tillåtelse att röra sig åt olika håll
const move = [];
const move1 = [];

function Movement(playerIndex) {


move1.push([players[0], true, true, true, true]);
console.log(move1[players[0]].left);
move1[0][0] = false;
console.table(move1);

for(let i = 0; i < players.length; i++){   

    //om spelaren kan röra sig åt vänster/höger, ej stoppad av border
    move.push({
    player: players[i],
    left : true,
    right :  true,
    up : true,
    down : true
    });

//walls
    if(players[i].x < 50){
        move[i].left = false;
    } 
    if(players[i].y < 50){
        move[i].up = false;
    } 
    if(players[i].x + 120 > totalWidth){
        move[i].right = false;
    } 
    if(players[i].y + 150 > totalHeight){
        move[i].down = false;
    }
}
    //w a s d knappar för spelare 0
    if (playerIndex == 0) {
        CollisionDetection(players[0]);
        let direction;
if (keyboard.d && move[0].right) {
    players[playerIndex].x += playerSpeed;
    direction = "right";
}
if (keyboard.a && move[0].left) {
    players[playerIndex].x -= playerSpeed;
    direction = "left";
}
if (keyboard.w && move[0].up) {
    players[playerIndex].y -= playerSpeed;
    direction = "up";

}
if (keyboard.s && move[0].down) {
    players[playerIndex].y += playerSpeed;
    direction = "down";
}

if(collisionDetection.includes(players[0])){
    move[0].direction = false;
}

//piltangenter för spelare 1
} else {
if (keyboard.right && move[1].right) {
    players[playerIndex].x += playerSpeed;
}
if (keyboard.left && move[1].left) {
    players[playerIndex].x -= playerSpeed;
}
if (keyboard.up && move[1].up) {
    players[playerIndex].y -= playerSpeed;
}
if (keyboard.down && move[1].down) {
    players[playerIndex].y += playerSpeed;
}
}
}
const collisionDetection = [];

function CollisionDetection(object){
    circle(players[0].x, players[0].y, 10, "red");
    circle(players[1].x, players[1].y, 10, "blue");
        for(let m = 0; m < map.length; m++){
            if(object.x >= map[m][0] && object.x <= (map[m][0] + map[m][2]) && object.y > map[m][1] && object.y < (map[m][1] + map[m][3])) {
                console.log("collision");
                if(!collisionDetection.includes(object)){
                    console.log("tetetette");
                    collisionDetection.push(object);
                }
            }
        }
}

function Health(playerIndex) {

    text(0, 70, 20, "SPELARE 1:" + players[0].health, "red");
    text(250, 70, 20, "SPELARE 2:" + players[1].health, "red");

    if (players[playerIndex].health >= 20) {
        picture(healthBar[playerIndex].x, healthBar[playerIndex].y, "img/health1.png");
    } else if (players[playerIndex].health >= 16) {
        picture(healthBar[playerIndex].x, healthBar[playerIndex].y, "img/health2.png");
    } else if (players[playerIndex].health >= 12) {
        picture(healthBar[playerIndex].x, healthBar[playerIndex].y, "img/health3.png");
    } else if (players[playerIndex].health >= 8) {
        picture(healthBar[playerIndex].x, healthBar[playerIndex].y, "img/health4.png");
    } else if (players[playerIndex].health >= 4) {
        picture(healthBar[playerIndex].x, healthBar[playerIndex].y, "img/health5.png");
    } else if (players[playerIndex].health > 0) {
        picture(healthBar[playerIndex].x, healthBar[playerIndex].y, "img/health6.png");
    } else {
        picture(healthBar[playerIndex].x, healthBar[playerIndex].y, "img/healthDead.png");
    }

}

    </script>
</body>
</html>